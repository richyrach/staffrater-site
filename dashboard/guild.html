<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Staff Rater — Guild Settings</title>
  <link rel="icon" href="/staff-rater-icon.png">

  <!-- Canonical host lock -->
  <script>
  (function(){
    var wanted="www.staffrater.xyz";
    if(location.host!==wanted){
      location.replace("https://"+wanted+location.pathname+location.search+location.hash);
    }
  })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; } html, body { background: #070b14; }
    .panel { background-color: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius: 16px; }
    .menu a { display:block; padding:.65rem .9rem; border-radius:.6rem; color: rgba(255,255,255,.75); }
    .menu a:hover, .menu a.active { background: rgba(255,255,255,.08); color:#fff; }
  </style>
</head>
<body class="text-white font-sans antialiased">
  <header class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-[#070b14]/50 bg-[#070b14]/80 border-b border-white/5">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/dashboard/index.html" class="flex items-center gap-3">
        <img src="/staff-rater-icon.png" class="w-8 h-8 rounded-xl ring-1 ring-white/10" alt="">
        <span class="text-white/90 font-semibold">Staff Rater — Guild</span>
      </a>
      <div id="auth-area" class="flex items-center gap-3">
        <a href="/api/login?return=/dashboard/index.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">Sign in</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 grid lg:grid-cols-[240px,1fr] gap-6">
    <aside class="panel p-3 menu">
      <div class="text-white/70 text-sm mb-2">Sections</div>
      <a href="#overview" class="active">Overview</a>
      <a href="#ratings">Ratings</a>
      <a href="#tickets">Tickets</a>
      <a href="#applications">Applications</a>
      <a href="#polls">Polls</a>
      <a href="#commandlog">Command Log</a>
    </aside>

    <section class="space-y-6">
      <div class="panel p-5">
        <div class="flex items-center justify-between">
          <h1 class="text-xl font-semibold" id="guildTitle">Server</h1>
          <a id="backBtn" href="/dashboard/index.html" class="text-white/70 hover:text-white">← All servers</a>
        </div>
        <p class="text-white/70 mt-2">Configure your Staff Rater bot settings for this server.</p>
      </div>

      <div id="overview" class="panel p-5">
        <h2 class="font-semibold">Overview</h2>
        <div id="info" class="text-white/70 mt-2 text-sm">Loading…</div>
      </div>

      <div id="ratings" class="panel p-5">
        <h2 class="font-semibold">Ratings</h2>
        <div class="text-white/70 mt-2 text-sm">Setup rating and result channels here. (UI wired to your existing /api/config-get and /api/config-set endpoints.)</div>
      </div>

      <div id="tickets" class="panel p-5">
        <h2 class="font-semibold">Tickets</h2>
        <div class="text-white/70 mt-2 text-sm">Configure ticket category/staff role/log channel. (Use names on your side; API continues to use IDs.)</div>
      </div>

      <div id="applications" class="panel p-5">
        <h2 class="font-semibold">Applications</h2>
        <div class="text-white/70 mt-2 text-sm">Create templates, add questions, review submissions.</div>
      </div>

      <div id="polls" class="panel p-5">
        <h2 class="font-semibold">Polls</h2>
        <div class="text-white/70 mt-2 text-sm">Manage recent polls here.</div>
      </div>

      <div id="commandlog" class="panel p-5">
        <h2 class="font-semibold">Live Command Log</h2>
        <div id="log" class="text-white/70 mt-2 text-sm">Waiting for events…</div>
      </div>
    </section>
  </main>

  <script>
  (function(){
    // 1) Capture token
    (function captureToken() {
      try {
        var t=null;
        if (location.hash) {
          var m = location.hash.match(/(?:^|[&#])token=([^&#]+)/);
          if (m) t = decodeURIComponent(m[1]);
        }
        if (!t && location.search) {
          var m2 = location.search.match(/(?:\?|&)token=([^&#]+)/);
          if (m2) t = decodeURIComponent(m2[1]);
        }
        if (t) {
          sessionStorage.setItem('sr_token', t);
          var clean = location.origin + location.pathname + location.search.replace(/([?&])token=[^&#]+(&|$)/, function(_,a,b){return a==='?'&&b?'?':''}) + (location.hash.replace(/(#|&)token=[^&#]+/,'')||'');
          history.replaceState(null,'', clean);
        }
      } catch(e){}
    })();

    // 2) Patch fetch
    (function patchFetch(){
      var orig = window.fetch;
      window.fetch = function(input, init){
        try{
          var url = (typeof input==='string')?input:input.url;
          if (url && url.indexOf('http')!==0 && url.startsWith('/api/')){
            init = init || {};
            var h = new Headers(init.headers || {});
            var tok = sessionStorage.getItem('sr_token');
            if (tok) h.set('Authorization','Bearer '+tok);
            init.headers = h;
            if (!('credentials' in init)) init.credentials='omit';
            if (!('cache' in init)) init.cache='no-store';
            return orig(url, init);
          }
        }catch(e){}
        return orig(input, init);
      };
    })();

    // 3) Load session, guild info, basic wiring
    (async function hydrate(){
      const auth=document.getElementById('auth-area');
      const info=document.getElementById('info');
      const log=document.getElementById('log');
      const params=new URLSearchParams(location.search);
      const guildId=params.get('guild_id')||'';
      document.getElementById('guildTitle').textContent = guildId ? `Server — ${guildId}` : 'Server';

      let me=null;
      try {
        const r=await fetch('/api/me');
        me = r.ok ? await r.json() : null;
      } catch(e){}

      if (!me || !me.ok) {
        auth.innerHTML = `<a href="/api/login?return=/dashboard/guild.html${guildId?`?guild_id=${encodeURIComponent(guildId)}`:''}" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">Sign in</a>`;
        info.textContent = 'Please sign in.';
        return;
      }

      const u=me.session.user;
      const avatar = u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64` : 'https://cdn.discordapp.com/embed/avatars/0.png';
      auth.innerHTML = `
        <a href="/dashboard/index.html" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">All servers</a>
        <div class="flex items-center gap-3">
          <img src="${avatar}" class="w-8 h-8 rounded-full ring-1 ring-white/10" alt="">
          <span class="text-white/80 text-sm max-w-[140px] truncate">${u.username}</span>
          <a href="/api/logout?redirect=/dashboard/index.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">Log out</a>
        </div>`;

      // Show a simple overview (you can replace with your /api/guild-structure)
      try {
        const r2 = await fetch('/api/guild-structure?guild_id='+encodeURIComponent(guildId));
        if (r2.ok) {
          const data = await r2.json();
          info.textContent = `Loaded guild structure: ${data ? 'ok' : 'empty'}`;
        } else {
          info.textContent = 'Could not load guild structure.';
        }
      } catch (e) {
        info.textContent = 'Error loading guild structure.';
      }

      // Live command log (basic poll)
      async function pollLog(){
        try{
          const r=await fetch('/api/command-log-get?guild_id='+encodeURIComponent(guildId));
          if(r.ok){
            const j=await r.json();
            log.textContent = (j && j.items && j.items.length)
              ? j.items.slice(-10).map(x => `[${new Date(x.ts||Date.now()).toLocaleTimeString()}] ${x.user||'someone'} used ${x.cmd||'a command'}`).join('\n')
              : 'No recent commands.';
          }
        }catch(e){}
        setTimeout(pollLog, 4000);
      }
      if (guildId) pollLog();
    })();
  })();
  </script>
</body>
</html>
