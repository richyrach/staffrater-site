<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Staff Rater — Dashboard</title>
  <link rel="icon" href="/staff-rater-icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#070b14; color:#e5e7eb; }
    .card { background:#0c1322; border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .input { background:#0b1120; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:.65rem .8rem; width:100%; outline:none; }
    .input:focus { border-color:#6366f1; box-shadow:0 0 0 2px #6366f144; }
    .btn { background:#4f46e5; color:white; border-radius:10px; padding:.6rem .9rem; }
    .btn:disabled { opacity:.5; }
    a.link { color:#93c5fd; }
  </style>
</head>
<body>
  <!-- top -->
  <header class="sticky top-0 z-40 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <img src="/staff-rater-icon.png" class="w-7 h-7 rounded" alt="">
        <span class="font-semibold">Staff Rater</span>
      </a>
      <div id="auth-box" class="flex items-center gap-3">
        <!-- filled by script (profile or login) -->
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <h1 class="text-2xl font-semibold">Dashboard</h1>

    <!-- Pick server -->
    <section class="card p-4">
      <div class="flex items-center gap-3">
        <img src="/staff-rater-icon.png" class="w-6 h-6 opacity-70" alt="">
        <h2 class="font-semibold">Select a server (you must be Owner/Admin/Manage Server)</h2>
      </div>
      <div class="mt-4 grid sm:grid-cols-2 gap-3">
        <select id="guildSelect" class="input">
          <option value="">— choose a server —</option>
        </select>
        <button id="reloadGuilds" class="btn">Refresh</button>
      </div>
      <p class="mt-3 text-sm opacity-80">Tip: enable Discord “Developer Mode” to copy IDs (User Settings → Advanced). Right-click channels/roles to copy ID.</p>
    </section>

    <!-- Settings form -->
    <section class="card p-4">
      <div class="flex items-center gap-3">
        <span class="font-semibold">Guild Settings</span>
        <span id="status" class="text-sm opacity-80"></span>
      </div>

      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm opacity-80">Rating Channel ID</label>
          <input id="rating_channel" class="input" placeholder="e.g. 123456789012345678" />
        </div>
        <div>
          <label class="text-sm opacity-80">Result Channel ID</label>
          <input id="result_channel" class="input" placeholder="e.g. 123456789012345678" />
        </div>
        <div>
          <label class="text-sm opacity-80">Ticket Category ID</label>
          <input id="ticket_category" class="input" placeholder="e.g. 123456789012345678" />
        </div>
        <div>
          <label class="text-sm opacity-80">Ticket Staff Role ID</label>
          <input id="ticket_staff_role" class="input" placeholder="e.g. 123456789012345678" />
        </div>
        <div>
          <label class="text-sm opacity-80">Ticket Log Channel ID (optional)</label>
          <input id="ticket_log_channel" class="input" placeholder="e.g. 123456789012345678" />
        </div>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="saveBtn" class="btn">Save Settings</button>
        <span id="saveMsg" class="text-sm"></span>
      </div>
    </section>
  </main>

  <script>
  // Reuse top-bar auth UI from earlier
  (async function authUI(){
    const box = document.getElementById('auth-box');
    const el = (t,a={},c=[])=>{const e=document.createElement(t);Object.entries(a).forEach(([k,v])=>k==='class'?e.className=v:e.setAttribute(k,v));c.forEach(x=>e.append(x));return e;}
    try {
      const r = await fetch('/api/me', { credentials:'include' });
      if (!r.ok) throw 0;
      const me = await r.json();
      const avatar = el('img',{src:me.avatar,alt:me.username,class:'w-8 h-8 rounded-full ring-2 ring-white/10'});
      const name = el('span',{class:'text-sm opacity-90'},[document.createTextNode(me.global_name||me.username)]);
      const out = el('a',{href:'/api/logout',class:'px-3 py-1 rounded bg-white/10 hover:bg-white/20 text-sm'},[document.createTextNode('Logout')]);
      box.replaceChildren(avatar,name,out);
    } catch {
      const login = document.createElement('a');
      login.href='/api/login'; login.className='px-3 py-1 rounded bg-indigo-500/80 hover:bg-indigo-500 text-white text-sm';
      login.textContent='Sign in with Discord';
      box.replaceChildren(login);
    }
  })();

  // Dashboard logic
  const sel = document.getElementById('guildSelect');
  const reloadBtn = document.getElementById('reloadGuilds');
  const status = document.getElementById('status');
  const fields = ['rating_channel','result_channel','ticket_category','ticket_staff_role','ticket_log_channel'];
  const els = Object.fromEntries(fields.map(id=>[id, document.getElementById(id)]));
  const saveBtn = document.getElementById('saveBtn');
  const saveMsg = document.getElementById('saveMsg');

  async function loadGuilds(){
    sel.innerHTML = '<option value="">— choose a server —</option>';
    const r = await fetch('/api/guilds', { credentials:'include' });
    if(!r.ok){ status.textContent='(login required)'; return; }
    const list = await r.json();
    list.filter(g=>g.canManage).forEach(g=>{
      const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; sel.appendChild(o);
    });
    status.textContent = '(pick a server)';
  }

  async function loadConfig(gid){
    if(!gid){ fields.forEach(k=>els[k].value=''); return; }
    status.textContent='Loading...';
    const r = await fetch(`/api/config-get?guild_id=${gid}`, { credentials:'include' });
    if(!r.ok){ status.textContent='(no access)'; return; }
    const cfg = await r.json();
    fields.forEach(k=>els[k].value = cfg[k] || '');
    status.textContent='Loaded.';
  }

  async function saveConfig(){
    const gid = sel.value; if(!gid) return;
    saveBtn.disabled = true; saveMsg.textContent='Saving...';
    const body = {};
    fields.forEach(k=>body[k]=els[k].value.trim());
    const r = await fetch(`/api/config-set?guild_id=${gid}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify(body)
    });
    saveBtn.disabled = false;
    if(!r.ok){ saveMsg.textContent='Failed (check access)'; return; }
    saveMsg.textContent='Saved ✅';
    setTimeout(()=>saveMsg.textContent='', 2000);
  }

  reloadBtn.onclick = loadGuilds;
  sel.onchange = () => loadConfig(sel.value);
  saveBtn.onclick = saveConfig;

  loadGuilds();
  </script>
</body>
</html>
