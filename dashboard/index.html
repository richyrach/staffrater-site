<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Staff Rater â€” Dashboard</title>
  <link rel="icon" href="/staff-rater-icon.png">

  <!-- Canonical host lock -->
  <script>
  (function(){
    var wanted="www.staffrater.xyz";
    if(location.host!==wanted){
      location.replace("https://"+wanted+location.pathname+location.search+location.hash);
    }
  })();
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    html, body { background: #070b14; }
    .tile { transition: transform .25s ease, box-shadow .25s ease; }
    .tile:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,.35); }
  </style>
</head>
<body class="text-white font-sans antialiased">
  <header class="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-[#070b14]/50 bg-[#070b14]/80 border-b border-white/5">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <img src="/staff-rater-icon.png" class="w-8 h-8 rounded-xl ring-1 ring-white/10" alt="">
        <span class="text-white/90 font-semibold">Staff Rater</span>
      </a>
      <div id="auth-area" class="flex items-center gap-3">
        <a href="/api/login?return=/dashboard/index.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">Sign in with Discord</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <h1 class="text-2xl font-semibold">Pick a server</h1>

    <!-- Signed-out notice -->
    <div id="signed-out" class="mt-6 rounded-2xl bg-white/5 ring-1 ring-white/10 p-5 hidden">
      <p class="text-white/80">Please sign in to see your servers.</p>
      <a href="/api/login?return=/dashboard/index.html" class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600">Sign in with Discord</a>
    </div>

    <!-- Server tiles -->
    <div id="grid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
  </main>

  <script>
  (function(){
    // 1) Capture token from HASH/QUERY, save, clean
    (function captureToken() {
      try {
        var t=null;
        if (location.hash) {
          var m = location.hash.match(/(?:^|[&#])token=([^&#]+)/);
          if (m) t = decodeURIComponent(m[1]);
        }
        if (!t && location.search) {
          var m2 = location.search.match(/(?:\?|&)token=([^&#]+)/);
          if (m2) t = decodeURIComponent(m2[1]);
        }
        if (t) {
          sessionStorage.setItem('sr_token', t);
          var clean = location.origin + location.pathname + location.search.replace(/([?&])token=[^&#]+(&|$)/, function(_,a,b){return a==='?'&&b?'?':''}) + (location.hash.replace(/(#|&)token=[^&#]+/,'')||'');
          history.replaceState(null,'', clean);
        }
      } catch(e){}
    })();

    // 2) Patch fetch for /api/*
    (function patchFetch(){
      var orig = window.fetch;
      window.fetch = function(input, init){
        try{
          var url = (typeof input==='string')?input:input.url;
          if (url && url.indexOf('http')!==0 && url.startsWith('/api/')){
            init = init || {};
            var h = new Headers(init.headers || {});
            var tok = sessionStorage.getItem('sr_token');
            if (tok) h.set('Authorization','Bearer '+tok);
            init.headers = h;
            if (!('credentials' in init)) init.credentials='omit';
            if (!('cache' in init)) init.cache='no-store';
            return orig(url, init);
          }
        }catch(e){}
        return orig(input, init);
      };
    })();

    // 3) Hydrate header and server grid
    (async function hydrate(){
      const auth=document.getElementById('auth-area');
      const grid=document.getElementById('grid');
      const signedOut=document.getElementById('signed-out');

      let me=null;
      try {
        const r=await fetch('/api/me');
        me = r.ok ? await r.json() : null;
      } catch(e){}

      if (!me || !me.ok) {
        signedOut.classList.remove('hidden');
        return;
      }

      // Header
      const u = me.session.user;
      const avatar = u.avatar ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png?size=64` : 'https://cdn.discordapp.com/embed/avatars/0.png';
      auth.innerHTML = `
        <a href="/" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">Home</a>
        <div class="flex items-center gap-3">
          <img src="${avatar}" class="w-8 h-8 rounded-full ring-1 ring-white/10" alt="">
          <span class="text-white/80 text-sm max-w-[140px] truncate">${u.username}</span>
          <a href="/api/logout?redirect=/dashboard/index.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 ring-1 ring-white/10">Log out</a>
        </div>`;

      // Servers
      let guilds = me.session.guilds || [];
      // show only guilds where user has MANAGE_GUILD or ADMINISTRATOR or is owner (for config)
      const ADMIN = 0x00000008;
      const MANAGE_GUILD = 0x00000020;
      guilds = guilds.filter(g => g.owner || ((g.permissions & (ADMIN|MANAGE_GUILD)) !== 0));

      if (!guilds.length) {
        grid.innerHTML = `
          <div class="rounded-2xl bg-white/5 ring-1 ring-white/10 p-5">
            <p class="text-white/80">No manageable servers found.</p>
            <a href="https://discord.com/oauth2/authorize?client_id=1410293903630012508&permissions=8&integration_type=0&scope=bot+applications.commands" class="mt-3 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600">Invite the bot</a>
          </div>`;
        return;
      }

      grid.innerHTML = guilds.map(g=>{
        const icon = g.icon ? `https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png?size=128` : 'https://cdn.discordapp.com/embed/avatars/1.png';
        return `
          <a class="tile block rounded-2xl bg-white/5 ring-1 ring-white/10 p-5" href="/dashboard/guild.html?guild_id=${encodeURIComponent(g.id)}">
            <div class="flex items-center gap-4">
              <img src="${icon}" class="w-12 h-12 rounded-xl ring-1 ring-white/10" alt="">
              <div>
                <div class="font-semibold">${g.name}</div>
                <div class="text-white/60 text-sm">${g.owner ? 'Owner' : 'Staff'}</div>
              </div>
            </div>
          </a>`;
      }).join('');
    })();
  })();
  </script>
</body>
</html>
